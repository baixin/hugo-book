<div class="flex flex-wrap justify-between">

<div>
{{ if and .GitInfo .Site.Params.BookLastChangeLink }}
  {{- $date := partial "docs/date" (dict "Date" .Lastmod "Format" .Site.Params.BookDateFormat) -}}
  <a class="flex align-center" href="{{ partial "docs/links/commit" . }}" title='{{ i18n "Last modified by" }} {{ .GitInfo.AuthorName }} | {{ $date }}' target="_blank" rel="noopener">
    <img src="{{ partial "docs/icon" "calendar" }}" class="book-icon" alt="" />
    <span>{{ $date }}</span>
  </a>
{{ end }}
</div>

<div>
{{ if and .File .Site.Params.BookEditLink }}
  <a class="flex align-center" href="{{ partial "docs/links/edit" . }}" target="_blank" rel="noopener edit">
    <img src="{{ partial "docs/icon" "edit" }}" class="book-icon" alt="" />
    <span>{{ i18n "Edit this page" }}</span>
  </a>
{{ end }}
</div>

</div>

<!-- <script>
(function() {
  console.log('Download tracker script loaded');

  // 发送统计请求
  function trackDownload(file) {
    fetch('https://download-collector.ctf-book.workers.dev/collect-download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ file })
    })
    .then(response => response.json())
    .then(data => console.log('统计数据', data))
    .catch(err => console.error('统计失败', err));
  }

  document.addEventListener("DOMContentLoaded", function() {
    const links = document.querySelectorAll('.download-link[data-file]');
    if (links.length === 0) console.warn('没有找到任何 download-link');

    links.forEach(link => {
      // 左键单击
      link.addEventListener('click', function(e) {
        if (!e.ctrlKey && !e.metaKey) { // 普通左键
          e.preventDefault();
          const url = this.href;
          const file = this.dataset.file;
          console.log('左键点击触发', file, url);
          trackDownload(file);
          setTimeout(() => { window.location = url; }, 200);
        } else {
          console.log('左键+Ctrl/Cmd点击，新标签页打开，统计发送');
          trackDownload(this.dataset.file);
        }
      });

      // 中键点击
      link.addEventListener('auxclick', function(e) {
        if (e.button === 1) { // 中键
          console.log('中键点击触发', this.dataset.file);
          trackDownload(this.dataset.file);
        }
      });

      // 右键菜单
      link.addEventListener('contextmenu', function(e) {
        console.log('右键菜单触发', this.dataset.file);
        trackDownload(this.dataset.file);
      });
    });
  });
})();
</script> -->

<!-- // ok for mac and android, but not for iOS -->
<script>
(function() {
  console.log('Download tracker script loaded');

  function trackDownload(file, url) {
    // 发送 GA 事件
    if (typeof gtag === "function") {
      gtag('event', 'file_download', {
        'file_name': file,
        'file_url': url
      });
    }

    // 如果还想统计到 Worker KV 或其他接口，可以在这里加入 fetch
    // fetch('https://download-collector.ctf-book.workers.dev/collect-download', {...})
    fetch('https://download-collector.ctf-book.workers.dev/collect-download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ file })
    })
    .then(response => response.json())
    .then(data => console.log('统计数据', data))
    .catch(err => console.error('统计失败', err));

    console.log('统计触发', file, url);
  }

  document.addEventListener("DOMContentLoaded", function() {
    const links = document.querySelectorAll('.download-link[data-file]');
    if (links.length === 0) console.warn('没有找到任何 download-link');

    links.forEach(link => {

      // 左键单击
      link.addEventListener('click', function(e) {
        const url = this.href;
        const file = this.dataset.file;

        if (!e.ctrlKey && !e.metaKey) { 
          e.preventDefault(); // 阻止默认直接跳转
          trackDownload(file, url);
          setTimeout(() => { window.location = url; }, 200); // 延迟跳转保证统计发送
        } else {
          // Ctrl/Cmd 打开新标签页，也统计
          trackDownload(file, url);
        }
      });

      // 中键点击
      link.addEventListener('auxclick', function(e) {
        if (e.button === 1) { 
          trackDownload(this.dataset.file, this.href);
        }
      });

      // 右键菜单
      link.addEventListener('contextmenu', function(e) {
        trackDownload(this.dataset.file, this.href);
      });
    });
  });
})();
</script>

<!-- <script>
(function() {
  // 防止重复绑定
  if (window._downloadShortcodeBound) return;
  window._downloadShortcodeBound = true;

  function trackDownload(file, url) {
    if (typeof gtag === "function") {
      if (navigator.sendBeacon) {
        const payload = JSON.stringify({ file_name: file, file_url: url });
        navigator.sendBeacon('https://www.google-analytics.com/collect', payload);
        console.log('sendBeacon 发送', file, url);
      } else {
        gtag('event', 'file_download', { file_name: file, file_url: url });
        console.log('gtag 发送', file, url);
      }
    }
  }

  function bindDownloadLinks() {
    const links = document.querySelectorAll('.download-link[data-file]');
    if (links.length === 0) return;

    links.forEach(link => {
      const handler = function(e) {
        const url = this.href;
        const file = this.dataset.file;

        if (!e.ctrlKey && !e.metaKey && e.type === 'click') {
          e.preventDefault();
          trackDownload(file, url);
          setTimeout(() => { window.location = url; }, 200);
        } else if (e.type === 'click') {
          trackDownload(file, url);
        } else if (e.type === 'auxclick' && e.button === 1) {
          trackDownload(file, url);
        } else if (e.type === 'contextmenu') {
          trackDownload(file, url);
        } else if (e.type === 'touchend') {
          e.preventDefault();
          trackDownload(file, url);
          setTimeout(() => { window.location = url; }, 200);
        }
      };

      link.addEventListener('click', handler);
      link.addEventListener('auxclick', handler);
      link.addEventListener('contextmenu', handler);
      link.addEventListener('touchend', handler);
    });
  }

  document.addEventListener("DOMContentLoaded", bindDownloadLinks);
})();
</script> -->

{{ partial "docs/prev-next" . }}

{{ $script := resources.Get "clipboard.js" | resources.Minify }}
{{ with $script.Content }}
  <script>{{ . | safeJS }}</script>
{{ end }}
