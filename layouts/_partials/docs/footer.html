<div class="flex flex-wrap justify-between">

<div>
{{ if and .GitInfo .Site.Params.BookLastChangeLink }}
  {{- $date := partial "docs/date" (dict "Date" .Lastmod "Format" .Site.Params.BookDateFormat) -}}
  <a class="flex align-center" href="{{ partial "docs/links/commit" . }}" title='{{ i18n "Last modified by" }} {{ .GitInfo.AuthorName }} | {{ $date }}' target="_blank" rel="noopener">
    <img src="{{ partial "docs/icon" "calendar" }}" class="book-icon" alt="" />
    <span>{{ $date }}</span>
  </a>
{{ end }}
</div>

<div>
{{ if and .File .Site.Params.BookEditLink }}
  <a class="flex align-center" href="{{ partial "docs/links/edit" . }}" target="_blank" rel="noopener edit">
    <img src="{{ partial "docs/icon" "edit" }}" class="book-icon" alt="" />
    <span>{{ i18n "Edit this page" }}</span>
  </a>
{{ end }}
</div>

</div>

<!-- <script>
document.addEventListener("DOMContentLoaded", function() {
  const links = document.querySelectorAll('.download-link[data-file]');
  links.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.href;
      const fileName = this.dataset.file;

      fetch('https://download-collector.ctf-book.workers.dev/collect-download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ file: fileName })
      }).then(() => {
        setTimeout(() => { window.location = url; }, 200);
      }).catch(() => {
        window.location = url;
      });
    });
  });
});
</script> -->

<!-- <script>
document.addEventListener('click', function(e) {
  // 找到最近的 .download-link[data-file] 元素
  const link = e.target.closest('.download-link[data-file]');
  if (!link) return; // 不是下载链接，直接返回

  e.preventDefault(); // 阻止默认跳转
  const url = link.href;
  const fileName = link.dataset.file;

  // 发送下载统计请求
  fetch('https://download-collector.ctf-book.workers.dev/collect-download', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ file: fileName })
  }).then(() => {
    // 等 200ms 后再跳转下载文件
    setTimeout(() => { window.location = url; }, 200);
  }).catch(() => {
    // 出错也跳转下载文件
    window.location = url;
  });
});
</script> -->

<!-- <script>
  // 全局事件委托，捕获所有点击事件
  document.addEventListener('click', function(e) {
    // 找到最近的下载链接
    const link = e.target.closest('a.download-link[data-file]');
    if (!link) return; // 如果不是下载链接，直接跳过

    e.preventDefault(); // 阻止默认跳转

    const url = link.href; // 获取文件真实地址
    const fileName = link.dataset.file; // 获取 data-file 属性

    // 发送统计请求
    fetch('https://download-collector.ctf-book.workers.dev/collect-download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ file: fileName })
    }).then(() => {
      // 成功后延迟跳转，确保统计完成
      setTimeout(() => { window.location = url; }, 200);
    }).catch(() => {
      // 失败也直接跳转，不阻塞下载
      window.location = url;
    });
  });
</script> -->

<script>
(function() {
  console.log('Download tracker script loaded');

  // 事件委托绑定到 body，保证动态生成的 <a> 也能捕获
  document.body.addEventListener('click', function(e) {
    const link = e.target.closest('.download-link[data-file]');
    if (!link) return; // 不是下载链接，忽略

    e.preventDefault(); // 阻止默认跳转
    const url = link.href;
    const fileName = link.dataset.file;

    console.log('点击下载触发', fileName, url);

    fetch('https://download-collector.ctf-book.workers.dev/collect-download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ file: fileName })
    })
    .then(response => {
      console.log('统计返回状态', response.status);
      return response.json();
    })
    .then(data => {
      console.log('统计数据', data);
      // 延迟跳转，保证请求发送完成
      setTimeout(() => {
        window.location = url;
      }, 200);
    })
    .catch(err => {
      console.error('统计失败', err);
      // 出错也跳转下载
      window.location = url;
    });
  });

})();
</script>

{{ partial "docs/prev-next" . }}

{{ $script := resources.Get "clipboard.js" | resources.Minify }}
{{ with $script.Content }}
  <script>{{ . | safeJS }}</script>
{{ end }}
