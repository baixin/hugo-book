<div class="flex flex-wrap justify-between">

<div>
{{ if and .GitInfo .Site.Params.BookLastChangeLink }}
  {{- $date := partial "docs/date" (dict "Date" .Lastmod "Format" .Site.Params.BookDateFormat) -}}
  <a class="flex align-center" href="{{ partial "docs/links/commit" . }}" title='{{ i18n "Last modified by" }} {{ .GitInfo.AuthorName }} | {{ $date }}' target="_blank" rel="noopener">
    <img src="{{ partial "docs/icon" "calendar" }}" class="book-icon" alt="" />
    <span>{{ $date }}</span>
  </a>
{{ end }}
</div>

<div>
{{ if and .File .Site.Params.BookEditLink }}
  <a class="flex align-center" href="{{ partial "docs/links/edit" . }}" target="_blank" rel="noopener edit">
    <img src="{{ partial "docs/icon" "edit" }}" class="book-icon" alt="" />
    <span>{{ i18n "Edit this page" }}</span>
  </a>
{{ end }}
</div>

</div>

<!-- <script>
(function() {
  console.log('Download tracker script loaded');

  // 发送统计请求
  function trackDownload(file) {
    fetch('https://download-collector.ctf-book.workers.dev/collect-download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ file })
    })
    .then(response => response.json())
    .then(data => console.log('统计数据', data))
    .catch(err => console.error('统计失败', err));
  }

  document.addEventListener("DOMContentLoaded", function() {
    const links = document.querySelectorAll('.download-link[data-file]');
    if (links.length === 0) console.warn('没有找到任何 download-link');

    links.forEach(link => {
      // 左键单击
      link.addEventListener('click', function(e) {
        if (!e.ctrlKey && !e.metaKey) { // 普通左键
          e.preventDefault();
          const url = this.href;
          const file = this.dataset.file;
          console.log('左键点击触发', file, url);
          trackDownload(file);
          setTimeout(() => { window.location = url; }, 200);
        } else {
          console.log('左键+Ctrl/Cmd点击，新标签页打开，统计发送');
          trackDownload(this.dataset.file);
        }
      });

      // 中键点击
      link.addEventListener('auxclick', function(e) {
        if (e.button === 1) { // 中键
          console.log('中键点击触发', this.dataset.file);
          trackDownload(this.dataset.file);
        }
      });

      // 右键菜单
      link.addEventListener('contextmenu', function(e) {
        console.log('右键菜单触发', this.dataset.file);
        trackDownload(this.dataset.file);
      });
    });
  });
})();
</script> -->

<script>
(function() {
  console.log('Download tracker script loaded');

  document.body.addEventListener('click', function(e) {
    const link = e.target.closest('.download-link[data-file]');
    if (!link) return;

    const url = link.href;
    const fileName = link.dataset.file;

    console.log('点击下载触发', fileName, url);

    const beaconUrl = 'https://download-collector.ctf-book.workers.dev/collect-download';
    const data = JSON.stringify({ file: fileName });

    if (navigator.sendBeacon) {
      // sendBeacon 版本
      const blob = new Blob([data], { type: 'application/json' });
      const sent = navigator.sendBeacon(beaconUrl, blob);
      console.log('sendBeacon 发送状态:', sent);
    } else {
      // fetch fallback 版本
      fetch(beaconUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: data,
        keepalive: true // 允许在页面卸载时继续发送
      }).then(r => console.log('fetch 发送状态:', r.status))
        .catch(err => console.error('fetch 发送失败', err));
    }

    // 左键单击立即跳转
    if (e.button === 0 && !e.metaKey && !e.ctrlKey && !e.shiftKey) {
      e.preventDefault();
      window.location = url;
    }
    // 中键/右键或带 Ctrl/Command/Shift 的点击保持默认行为
  });
})();
</script>

{{ partial "docs/prev-next" . }}

{{ $script := resources.Get "clipboard.js" | resources.Minify }}
{{ with $script.Content }}
  <script>{{ . | safeJS }}</script>
{{ end }}
